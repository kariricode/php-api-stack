# ============================================
# PHP API Stack Configuration
# Image: kariricode/php-api-stack
# ============================================

# Stack Versions (used during build)
PHP_VERSION=8.4
NGINX_VERSION=1.27.3
REDIS_VERSION=7.2
COMPOSER_VERSION=2.8.12
SYMFONY_CLI_VERSION=7.3.0

# PHP Extensions Configuration
# Core extensions - these will be installed via docker-php-ext-install
# ONLY installable extensions (built-in ones like tokenizer, fileinfo, ctype, iconv, session, curl are automatically available)
# Available: pdo pdo_mysql pdo_pgsql opcache intl zip bcmath gd mysqli mbstring xml dom simplexml sockets pcntl exif
PHP_CORE_EXTENSIONS="pdo pdo_mysql opcache intl zip bcmath gd mbstring xml sockets"

# PECL extensions - these will be installed via pecl
# Available: redis apcu uuid xdebug imagick amqp swoole
# Note: Remove xdebug for production builds
PHP_PECL_EXTENSIONS="redis apcu uuid"

# Application Settings
APP_NAME=php-api-stack
APP_ENV=production
APP_DEBUG=false
APP_PORT=8089
APP_DOMAIN=localhost

# Paths
APP_ROOT=/var/www/html
APP_PUBLIC_PATH=/var/www/html/public
LOG_PATH=/var/log
DATA_PATH=/var/lib

# Nginx Configuration
NGINX_WORKER_PROCESSES=auto
NGINX_WORKER_CONNECTIONS=2048
NGINX_KEEPALIVE_TIMEOUT=65
NGINX_CLIENT_MAX_BODY_SIZE=100M
NGINX_FASTCGI_BUFFER_SIZE=16k
NGINX_FASTCGI_BUFFERS="16 16k"
NGINX_GZIP=on
NGINX_GZIP_COMP_LEVEL=6
NGINX_ACCESS_LOG=/var/log/nginx/access.log
NGINX_ERROR_LOG=/var/log/nginx/error.log

# PHP Configuration
PHP_MEMORY_LIMIT=256M
PHP_MAX_EXECUTION_TIME=60
PHP_MAX_INPUT_TIME=60
PHP_POST_MAX_SIZE=100M
PHP_UPLOAD_MAX_FILESIZE=100M
PHP_MAX_FILE_UPLOADS=20
PHP_DATE_TIMEZONE=America/Sao_Paulo
PHP_DISPLAY_ERRORS=Off
PHP_ERROR_LOG=/var/log/php/error.log
PHP_SESSION_SAVE_HANDLER=redis
PHP_SESSION_SAVE_PATH="tcp://redis:6379"

# PHP-FPM Configuration
PHP_FPM_PM=dynamic
PHP_FPM_PM_MAX_CHILDREN=50
PHP_FPM_PM_START_SERVERS=5
PHP_FPM_PM_MIN_SPARE_SERVERS=5
PHP_FPM_PM_MAX_SPARE_SERVERS=10
PHP_FPM_PM_MAX_REQUESTS=500
PHP_FPM_PM_STATUS_PATH=/status
PHP_FPM_PING_PATH=/ping
PHP_FPM_ACCESS_LOG=/var/log/php/fpm-access.log
PHP_FPM_SLOW_LOG=/var/log/php/fpm-slow.log
PHP_FPM_REQUEST_SLOWLOG_TIMEOUT=30s

# OPcache Configuration
PHP_OPCACHE_ENABLE=1
PHP_OPCACHE_MEMORY=256
PHP_OPCACHE_MAX_FILES=20000
PHP_OPCACHE_VALIDATE_TIMESTAMPS=0
PHP_OPCACHE_REVALIDATE_FREQ=0
PHP_OPCACHE_JIT=tracing
PHP_OPCACHE_JIT_BUFFER_SIZE=128M

# Redis Configuration
REDIS_HOST=redis
REDIS_PASSWORD=
REDIS_DATABASES=16
REDIS_MAXMEMORY=256mb
REDIS_MAXMEMORY_POLICY=allkeys-lru
REDIS_APPENDONLY=yes
REDIS_APPENDFSYNC=everysec
REDIS_LOG_LEVEL=notice
REDIS_LOG_FILE=/var/log/redis/redis.log
REDIS_SAVE="900 1 300 10 60 10000"

# Supervisor Configuration
SUPERVISOR_LOG_LEVEL=info
SUPERVISOR_LOG_FILE=/var/log/supervisor/supervisord.log
SUPERVISOR_PID_FILE=/var/run/supervisord.pid

# Security Settings
SECURITY_HEADERS=true
SECURITY_CSP="default-src 'self'"
SECURITY_HSTS_MAX_AGE=31536000
RATE_LIMIT_ZONE_SIZE=10m
RATE_LIMIT_RATE=10r/s
RATE_LIMIT_BURST=20

# Performance Settings
ENABLE_CACHE=true
CACHE_TTL=3600
ENABLE_COMPRESSION=true
ENABLE_HTTP2=true

# Development Settings (set to true only in dev)
XDEBUG_ENABLE=false
XDEBUG_MODE=develop,debug,coverage
XDEBUG_HOST=host.docker.internal
XDEBUG_PORT=9003
XDEBUG_IDE_KEY=PHPSTORM

# Monitoring
ENABLE_METRICS=true
METRICS_PORT=9090
ENABLE_HEALTH_CHECK=true
HEALTH_CHECK_PATH=/health

# Build Settings
BUILD_TARGET=production
IMAGE_TAG=latest
REGISTRY=docker.io
REPOSITORY=kariricode/php-api-stack

# Resource Limits
CONTAINER_MEMORY_LIMIT=1G
CONTAINER_CPU_LIMIT=2
CONTAINER_MEMORY_RESERVATION=512M
CONTAINER_CPU_RESERVATION=0.5