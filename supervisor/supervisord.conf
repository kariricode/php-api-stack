[supervisord]
nodaemon=true
user=root
logfile=/var/log/supervisor/supervisord.log
pidfile=/var/run/supervisord.pid
loglevel=info
childlogdir=/var/log/supervisor
silent=false
minfds=1024
minprocs=200

[unix_http_server]
file=/var/run/supervisor.sock
chmod=0700
chown=root:root

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

[supervisorctl]
serverurl=unix:///var/run/supervisor.sock

# Nginx process
[program:nginx]
command=/usr/sbin/nginx -g 'daemon off;'
process_name=%(program_name)s
autostart=true
autorestart=unexpected
exitcodes=0
startsecs=10
startretries=3
priority=10
stdout_logfile=/var/log/nginx/stdout.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=5
stdout_capture_maxbytes=10MB
stderr_logfile=/var/log/nginx/stderr.log
stderr_logfile_maxbytes=10MB
stderr_logfile_backups=5
stderr_capture_maxbytes=10MB
stopasgroup=true
killasgroup=true
stopsignal=QUIT
stopwaitsecs=10
user=root

# PHP-FPM process
[program:php-fpm]
command=/usr/local/sbin/php-fpm -F -R
process_name=%(program_name)s
autostart=true
autorestart=unexpected
exitcodes=0
startsecs=10
startretries=3
priority=5
stdout_logfile=/var/log/php/fpm-stdout.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=5
stdout_capture_maxbytes=10MB
stderr_logfile=/var/log/php/fpm-stderr.log
stderr_logfile_maxbytes=10MB
stderr_logfile_backups=5
stderr_capture_maxbytes=10MB
stopasgroup=true
killasgroup=true
stopsignal=QUIT
stopwaitsecs=10
user=root

# Redis process
[program:redis]
command=/usr/local/bin/redis-server /etc/redis/redis.conf --daemonize no
process_name=%(program_name)s
autostart=true
autorestart=unexpected
exitcodes=0
startsecs=10
startretries=3
priority=1
stdout_logfile=/var/log/redis/stdout.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=5
stdout_capture_maxbytes=10MB
stderr_logfile=/var/log/redis/stderr.log
stderr_logfile_maxbytes=10MB
stderr_logfile_backups=5
stderr_capture_maxbytes=10MB
stopasgroup=true
killasgroup=true
stopsignal=TERM
stopwaitsecs=10
user=root
environment=HOME="/var/lib/redis"

# Symfony Messenger Consumer (disabled by default - optional worker)
[program:symfony-messenger]
command=/usr/local/bin/php /var/www/html/bin/console messenger:consume async --time-limit=3600 --memory-limit=256M
process_name=%(program_name)s_%(process_num)02d
numprocs=1
autostart=false
autorestart=true
startsecs=10
startretries=3
priority=20
stdout_logfile=/var/log/symfony/messenger-stdout.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=5
stderr_logfile=/var/log/symfony/messenger-stderr.log
stderr_logfile_maxbytes=10MB
stderr_logfile_backups=5
stopasgroup=true
killasgroup=true
stopsignal=TERM
stopwaitsecs=60
user=nginx
directory=/var/www/html

# Process groups
[group:webstack]
programs=nginx,php-fpm,redis
priority=999

[group:workers]
programs=symfony-messenger
priority=998